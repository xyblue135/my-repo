本文只讲文件结构，挂载命令看其它篇教程# 引入*

这里我就拿软路由的系统(Openwrt)做例子了,首先我们查看硬盘本身的扇区结构,可以看到有sda1,2,3分区.

![Pasted-image-20231205035703.png](00_sync/00linux/分区结构和文件系统类型和挂载点和Overlay/linux文件结构/Pasted-image-20231205035703.png)

# Win

如果上面分区不太懂,我们先对Win的分区结构中入手,可以看到我的WIN分区为ESP,MSR,C,D这四个分区(文件格式分别为FAT32,MSR,NTFS,NTFS)

![image-20231212229334.png](00_sync/00linux/分区结构和文件系统类型和挂载点和Overlay/linux文件结构/image-20231212229334.png)

## ESP分区

ESP分区是基于UEFI（统一可扩展固件接口）的计算机系统中的一个必需分区,它是一个FAT32格式的分区，用于存储引导加载程序和启动管理器所需的文件。ESP分区包含了启动操作系统所必需的引导文件,如bootloader（引导加载程序）/boot manager（引导管理器）和操作系统相关的文件。ESP分区还包含了用于启动和配置计算机的UEFI固件驱动程序.

## MSR分区

MSR分区是Windows操作系统中的一种预留分区，用于存储Windows系统内部使用的数据。它是一个小型的、不可见的分区，一般为128MB大小。MSR分区用于管理和维护磁盘的分区表和其他系统元数据信息。它不包含任何用户数据，而是用于Windows操作系统的内部目的，例如磁盘管理、备份和恢复操作等。

# 系统分区

剩下的C,D盘就是我的系统分区了,为微软的NTFS格式的.

# Linux

系统参考(一):以下说明将尽量优先此参考

![image-202312123559154.png](00_sync/00linux/分区结构和文件系统类型和挂载点和Overlay/linux文件结构/image-202312123559154.png)

系统参考(二):

![image-20231212130643.png](00_sync/00linux/分区结构和文件系统类型和挂载点和Overlay/linux文件结构/image-20231212130643.png)

## 分区(一)

### Sda1分区

1. 根分区（Root Partition）：sda1分区通常被用作根分区，也称为系统分区。它包含了操作系统的核心文件和目录，例如引导加载程序、配置文件和系统库等。根分区是Linux系统中的主要分区，用于安装和运行操作系统。

2. 系统保留分区：在某些情况下，sda1分区可能被用作系统保留分区，用于存储系统相关的文件和设置。这可能包括固件文件、启动文件、系统配置等。

3. 上图中的扫描工具是在Windows上的DiskGenius扫描的,实际上Windows扫描的kernel分区就是系统分区.

### sda2分区

1. 数据分区（Data Partition）：sda2分区可以被用作专门用于存储数据的分区。这可能包括数据库文件、日志文件、备份文件等。

### sda3,sda4,sda5分区

1. 这个分区一般需要手动配置,也就是说可以将linux的其它文件,如Docker挂载到这个分区中

### exFAT分区(win)

1. 这个分区是同时将u盘作为系统启动盘,且留有一定的空间当做u盘来正常使用,也就是windows上的exFAT格式.它不是windows上的格式.

2. 且需要注意,在Linux可以读取windows的分区,但是在windows默认上不可以读取linux的分区,需要驱动设备或软件.

### 注意

需要注意,sda1分区一般位于硬盘起始位置,但需要注意,分区的具体用途和功能可以根据用户的需求和系统配置而有所不同。所以,sda1和sda2只是示例分区名称，在实际系统中，分区的命名可以有所不同!!!!,下面是两个基于linux的openwrt的系统分区.需要注意,sda1分区一般建议为EXT4格式,而FAT16是windows格式的,但是linux上也是可以使用的,但可能会有一些隐患.(sda1分区通常建议使用较新的文件系统格式如EXT4，因为它提供更好的性能、可靠性和功能。FAT16是一种较旧的Windows文件系统格式,FAT16→FAT32→EXFTA)

## 分区(二)

我们可以看到sda1，sda2，sda3这样的分区，但每个分区的前面还有几百KB的文件，这个文件为这个分区的文件系统占用一定的空间来存储文件系统元数据（如超级块、索引节点等）以及文件和目录的数据。

![image-202312125155227.png](00_sync/00linux/分区结构和文件系统类型和挂载点和Overlay/linux文件结构/image-202312125155227.png)

而末尾分区为文件系统中未使用的空闲空间，会被视为文件系统的保留空间。操作系统和文件系统会自动管理这些空间，以便进行文件的存储和管理。

![image-202312125211187.png](00_sync/00linux/分区结构和文件系统类型和挂载点和Overlay/linux文件结构/image-202312125211187.png)

# 文件结构

## 使用lsblk查看设备的名称、大小、类型和挂载信息.

系统参考(一)

![image-20231213153198.png](00_sync/00linux/分区结构和文件系统类型和挂载点和Overlay/linux文件结构/image-20231213153198.png)

系统参考(二)

![image-2023121325394.png](00_sync/00linux/分区结构和文件系统类型和挂载点和Overlay/linux文件结构/image-2023121325394.png)

## 使用df-h查看文件系统的磁盘空间使用情况.

系统参考(一)

![image-20231213515587.png](00_sync/00linux/分区结构和文件系统类型和挂载点和Overlay/linux文件结构/image-20231213515587.png)

系统参考(二)

![image-20231213534831.png](00_sync/00linux/分区结构和文件系统类型和挂载点和Overlay/linux文件结构/image-20231213534831.png)

## 标注

![image-202312132639949.png](00_sync/00linux/分区结构和文件系统类型和挂载点和Overlay/linux文件结构/image-202312132639949.png)

请注意我画出的标注线(以系统参考二参考):红色为sda1,橙色为sda2,黄色为sda3,绿色为sda4,蓝色为RAM内存

## 标注解释

/dev/sdax是全称,sda是缩写.

### sda1(红色)

挂载到了boot,而"/dev/sda1" 是一个设备文件，表示第一个硬盘的第一个分区。文件系统一般为EXT4,它被挂载到了 "/boot" 目录，这意味着 "/boot" 目录是与 "/dev/sda1" 设备关联的文件系统的访问点。

![image-202312135615932.png](00_sync/00linux/分区结构和文件系统类型和挂载点和Overlay/linux文件结构/image-202312135615932.png)

### sda2(橘色)

都挂载到了rom.且是100%使用率.有一点不要混淆, sda3 分区的文件系统提供了 "/rom" 目录的存储空间，而 "/dev/root" 是访问该存储空间所使用的设备文件。但我的图中需要注意,我的sda2分区并没有被使用,请看下面overlay.

![image-202312132716497.png](00_sync/00linux/分区结构和文件系统类型和挂载点和Overlay/linux文件结构/image-202312132716497.png)

### sda3(黄色)

代表物理硬盘上的第三个分区sda3的文件系统挂载到了overlay这个分区中,但overlay这个分区不太一样,是联合挂载的,下面会详细说明.

### sda4(绿色)

代表物理硬盘上的第四个分区sda4的文件系统挂载到了/mnt/usb2_1_3-4这个文件夹中,在此文件夹放的所有东西都会占用sda4的空间.

### sda4(绿色下)

可以看到最下面的一条绿色是overlay文件系统挂载到了/mnt/usb2_1_3-4/docker/overlay2/....

但是事实上overlay应该可以理解为一个虚拟文件系统,然厚挂载到了/mnt/usb2_1_3-4/docker/overlay2/....,Overlay是通过将多个不同的文件系统合并成一个虚拟文件系统而创建的。它通过在顶层文件系统上叠加一个或多个更底层的文件系统，以提供可写的根文件系统。

也就是说我的docker首先给了overlay,然后overlay代替docker找到了/mnt/usb2_1_3-4/docker/overlay2/.....

### tmpfs(蓝色)

tmpfs是一种基于内存的文件系统，它将文件存储在内存中而不是硬盘上。在这种情况下，tmpfs文件系统被挂载到/tmp和/mnt/和/dev和/sys/module/md_mod/parameters/new_array目录，用于存储临时文件。这意味着/tmp和/mnt/和/dev和/sys/module/md_mod/parameters/new_array目录中的文件将存储在内存中，而不是硬盘上，这样可以提供更快的访问速度。也就是说如果我们在/tmp和/mnt/和/dev下面存文件的话,开机就会消失.

且我的内存总共为4G,并没有完全使用掉,也就避免了内存溢出.

### sda4和tmpfs重叠

图中我们可以看到sda4下面的/mnt/usb2_1_3-4目录下是2G的空间,而/mnt/usb2_1_3-4/docker/overlay2/.....是55G的空间,但是更上级目录/mnt是tmpfs挂载到的,只有4MB,但系统还是可以正常运行,但需要注意,如果要在/mnt目录下放文件,不可以超过4MB,而/mnt//mnt/usb2_1_3-4目录下放文件不能超过2G,以此类推.

### cgroup

可以看到cgroup挂载到了系统目录,而且它0%的占用,它来干嘛的?首先,`cgroup`（Control Group）并不是一个文件系统，而是 Linux 内核提供的一种资源管理机制(虚拟文件系统)。它用于限制、账户化和隔离进程组对系统资源（如 CPU、内存、磁盘 I/O、网络带宽等）的使用。它在 Linux 中的实现是通过 `/sys/fs/cgroup` 目录下的虚拟文件系统来提供接口和控制机制。这些虚拟文件系统在 `/sys/fs/cgroup` 目录下以不同的层次和控制器（controllers）表示。

而`cgroup` 文件系统的大小（1.9GB）表示逻辑大小，用于管理进程组的资源限制和配置，并不代表实际的磁盘空间占用。使用率为 0% 表示当前没有进程组使用 `cgroup` 进行资源管理。

### overlayfs:/overlay

文件结构是根目录 ("/")，这意味着这个O文件系统都被挂载到根目录下。在 Linux 中，根目录是文件系统的起始点，所有其他文件和目录都是从根目录开始的。

# overlay

Overlay的设计思想是将一个只读的基础文件系统(RAM)与一个可写(ROM)的上层文件系统层叠在一起。基础文件系统可以是 ROM（只读存储器）或其他持久存储设备上的文件系统，但上层文件系统通常是在 RAM 中创建的临时文件系统。这样，上层文件系统提供了可写的存储空间（在RAM中），用于存储新文件或对现有文件进行更改。运行好之后，这剩余的overlay的空间将由我们自由支配，即临时可写的空间（即系统重启后，该空间可能会被清空或者初始化）

![image-202312135957634.png](00_sync/00linux/分区结构和文件系统类型和挂载点和Overlay/linux文件结构/image-202312135957634.png)

使用`parted -l`命令可以看到sda2的文件系统并没有被现实,而web网页可以看到sda2的文件系统为squashfs,SquashFS是一种只读文件系统，通常用于压缩和存储操作系统或应用程序的根文件系统。它被设计为只读文件系统，因此不能直接用于启动操作系统。所以我的分区应该为sda1作为引导,然后执行sda3进行启动.而我的sda3系统崩溃的时候,就可以使用命令还原为默认状态,也就是初始化,(从sda2的squashfs的分区中复制出来到sda3的ext4分区中),算是一个救命稻草吧.

![image-20231213025890.png](00_sync/00linux/分区结构和文件系统类型和挂载点和Overlay/linux文件结构/image-20231213025890.png)

![image-20231213747622.png](00_sync/00linux/分区结构和文件系统类型和挂载点和Overlay/linux文件结构/image-20231213747622.png)

![image-2023121389482.png](00_sync/00linux/分区结构和文件系统类型和挂载点和Overlay/linux文件结构/image-2023121389482.png)

然后我们查看文件结构的信息的时候,也并没有看到sda2的挂载信息,我们应该就理解了squashfs格式了

![image-20231213930570.png](00_sync/00linux/分区结构和文件系统类型和挂载点和Overlay/linux文件结构/image-20231213930570.png)

![image-20231213301653.png](00_sync/00linux/分区结构和文件系统类型和挂载点和Overlay/linux文件结构/image-20231213301653.png)

# 关于使用overlay(一)

我们给overlay分区存个文件

![image-202312134825741.png](00_sync/00linux/分区结构和文件系统类型和挂载点和Overlay/linux文件结构/image-202312134825741.png)

![image-202312135115.png](00_sync/00linux/分区结构和文件系统类型和挂载点和Overlay/linux文件结构/image-202312135115.png)

来到了45%的占用率,内存使用率是不变的.

# 关于使用overlay(二)

而在overlay文件系统里有三个主要的文件夹和一个标识文件.

1. **lost+found：** 这是一个用于存放文件系统中损坏、丢失或无法识别属主的文件和文件碎片的文件夹。当文件系统发生某些问题时，例如意外断电或文件系统损坏，文件系统检查和修复工具（如 fsck）会尝试将这些损坏的文件和数据片段放置在 lost+found 目录中，以便稍后进行恢复或处理。

2. **upper：** 这个文件夹是 Overlay的一部分，它存储了用户对 Overlay所做的所有更改。当你修改 Overlay的内容时，所有新增、修改或删除的文件都会暂时存储在 upper 目录中，而不会直接修改底层的只读文件系统。

3. **work：** 这个文件夹也是 Overlay的一部分，用于执行 Overlay 操作时的临时工作目录。它在 Overlay操作期间用于存储中间数据和临时文件。这个目录在执行 Overlay 操作期间是临时创建和使用的。

4. **.rootfs-uuid：** 这个文件是一个标识文件，它包含底层文件系统的 UUID（Universally Unique Identifier），用于与 Overlay关联。它帮助系统识别和关联正确的底层文件系统和 Overlay

![image-202312131240823.png](00_sync/00linux/分区结构和文件系统类型和挂载点和Overlay/linux文件结构/image-202312131240823.png)

# 关于使用overlay(三)

对于overlay的上下层关系,可以理解为一种映射关系,可以看到有着主目录的大量文件.

![[1需要放入网站的笔记/分区结构、文件系统类型、文件结构以及 Overlay/待整理迁移/Pasted image 20231213212353.png]]

![image-20231213241752.png](00_sync/00linux/分区结构和文件系统类型和挂载点和Overlay/linux文件结构/image-20231213241752.png)

然后下面这个我将在overlay下创建xyblue2 3 4来验证映射关系.

![image-202312132342101.png](00_sync/00linux/分区结构和文件系统类型和挂载点和Overlay/linux文件结构/image-202312132342101.png)

而这就是上层文件的更改了,所以到这里你就应该能理解我们在使用`df-h`所战士的这两行的含义了,为什么是一样的.

![image-202312133033854.png](00_sync/00linux/分区结构和文件系统类型和挂载点和Overlay/linux文件结构/image-202312133033854.png)

然后下面这张图是关于overlay的上层文件没有的,但是/主目录有的截图,可以看到

![image-202312133359911.png](00_sync/00linux/分区结构和文件系统类型和挂载点和Overlay/linux文件结构/image-202312133359911.png)

- **ext_overlay：** 这可能是底层文件系统（Lower）的一部分，特别是如果它指向一个 Ext（例如 ext4）。但是请注意，这取决于你的系统设置和文件系统的安排，因此可能需要确认具体的文件系统配置。

- **mnt：** 通常用于挂载其他文件系统，也可以在上面看到,是RAM的tmpfs挂载上的.

- **overlay：** 这可能是 Overlay的一部分，特别是在使用 OverlayFS 作为文件系统时。它可能包含 `upper`、`lower` 和 `work` 等目录。

- **proc、sys 和 tmp：** 这些通常是虚拟文件系统，用于 Linux 系统的不同目的。它们通常不是底层文件系统的一部分，但在 Overlay中，可能会显示为整个文件系统的一部分。

- **rom 和 sbin：** 这些通常是系统中的固定文件夹。`rom` 可能表示只读的文件系统，而 `sbin` 通常包含系统二进制文件和系统命令。它们可能是底层文件系统（Lower）的一部分，但也可能不是 Overlay的一部分。

# 关于使用tmp

/tmp目录通常是可读写的，任何用户都可以在其中创建和访问临时文件。它提供了一个公共的位置，供系统中的不同组件和进程进行临时数据的交换和共享。但是重启会丢失,因为是RAM内存文件系统tmpfs挂载到的tmp目录下.

/tmp目录的大小设置为系统RAM的一部分，通常建议为系统RAM的一半。如我的RAM总数值为4GB,我给了tmp2GB的空间.

![image-20231213575480.png](00_sync/00linux/分区结构和文件系统类型和挂载点和Overlay/linux文件结构/image-20231213575480.png)

可以看到,我设备在正常运行的时候RAM的目前使用率在19%

![image-202312135944401.png](00_sync/00linux/分区结构和文件系统类型和挂载点和Overlay/linux文件结构/image-202312135944401.png)

而如果我向tmp目录下放文件的话,

![image-20231213046667.png](00_sync/00linux/分区结构和文件系统类型和挂载点和Overlay/linux文件结构/image-20231213046667.png)

完成后.

![image-20231213118933.png](00_sync/00linux/分区结构和文件系统类型和挂载点和Overlay/linux文件结构/image-20231213118933.png)

![image-20231213131108.png](00_sync/00linux/分区结构和文件系统类型和挂载点和Overlay/linux文件结构/image-20231213131108.png)

![image-202312132749.png](00_sync/00linux/分区结构和文件系统类型和挂载点和Overlay/linux文件结构/image-202312132749.png)

可以看到我们再tmp目录下放的文件是会占用内存RAM的.所以重启后我们的数据是会丢失的.

## 警告

如果你执意把sda3挂载的overlay分区填满的话，可能会造成？数据丢失或损坏，从而丢失数据或损坏文件系统，程序或服务崩溃，操作系统故障等，确保在任何时候都保持足够的可用空间。建议在分区空间使用率接近满时采取适当的措施！！！！

例子：ping组件丢失，重启防火墙组件可以正常使用，但下游网络配置莫名清空。且reboot，poweroff命令无法使用，自带opkg也失效。只能从sda2的squashfs恢复到出厂设置。

![3fb761b7d94b2a1e5f55acd3c2a6c1c.jpg](00_sync/00linux/分区结构和文件系统类型和挂载点和Overlay/linux文件结构/3fb761b7d94b2a1e5f55acd3c2a6c1c.jpg)